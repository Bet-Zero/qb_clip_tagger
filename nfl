#!/usr/bin/env python3
import sys
import os
import subprocess
import socket
import time

PROJECT_DIR = "/Volumes/Samsung PSSD T7/NFLFilm/__Tools/qb_clip_tagger"
os.chdir(PROJECT_DIR)

def is_port_in_use(port=5000):
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        return s.connect_ex(('localhost', port)) == 0

def ensure_flask_running():
    if not is_port_in_use(5000):
        subprocess.Popen(["python3", "app.py"],
                         cwd=PROJECT_DIR,
                         stdout=subprocess.DEVNULL,
                         stderr=subprocess.DEVNULL)
        time.sleep(2)

def launch_electron(route):
    electron_path = os.path.join(PROJECT_DIR, "node_modules", ".bin", "electron")
    main_js = os.path.join(PROJECT_DIR, "electron_app", "main.js")

    subprocess.Popen(
        [
            electron_path,
            main_js,
            route,
            "--disable-gpu",
            "--disable-software-rasterizer"
        ],
        cwd=PROJECT_DIR
    )


def launch_watcher():
    watcher_path = os.path.join(PROJECT_DIR, "watcher.py")
    try:
        subprocess.run(["python3", watcher_path], cwd=PROJECT_DIR)
    except KeyboardInterrupt:
        print("\n\033[1;31m‚ùå Tagger watcher stopped by user.\033[0m\n")


def main():
    if len(sys.argv) < 2:
        print("Usage: qb [tagger|search|watcher]")
        return

    cmd = sys.argv[1]

    if cmd == "tagger":
        launch_watcher()

    elif cmd == "search":
        ensure_flask_running()
        launch_electron("search")

    elif cmd == "watcher":
        launch_watcher()

    else:
        print("Unknown command. Use: qb [tagger|search|watcher]")

if __name__ == "__main__":
    main()
