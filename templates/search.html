<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Search Clips</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script src="{{ url_for('static', filename='taggerData.js') }}"></script>
    <script src="{{ url_for('static', filename='playerSuggest.js') }}"></script>
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const playerNames = JSON.parse(
          document.getElementById("player-data").textContent
        );

        enablePlayerSuggestions(
          document.querySelector('input[name="player"]'),
          playerNames
        );

        // Add click handlers for traits and badges after they are created
        // This will be done after populateTags() runs in taggerData.js

        document
          .querySelectorAll(".side-group .toggle-button")
          .forEach((btn) => {
            btn.addEventListener("click", () => {
              document
                .querySelectorAll(".side-group .toggle-button")
                .forEach((b) => b.classList.remove("selected"));
              btn.classList.add("selected");
              document.querySelector('input[name="side"]').value =
                btn.dataset.value;
            });
          });

        document
          .querySelectorAll(".quality-group .toggle-button")
          .forEach((btn) => {
            btn.addEventListener("click", () => {
              const wasSelected = btn.classList.contains("selected");
              document
                .querySelectorAll(".quality-group .toggle-button")
                .forEach((b) => b.classList.remove("selected"));
              const hidden = document.querySelector('input[name="quality"]');
              if (wasSelected) {
                if (hidden) hidden.value = "";
              } else {
                btn.classList.add("selected");
                if (hidden) hidden.value = btn.dataset.value;
              }
            });
          });

        document.querySelectorAll(".filter-input").forEach((input) => {
          input.addEventListener("input", () => {
            const box = input.closest(".tag-box");
            const container = box.querySelector(".tag-list");
            const query = input.value.toLowerCase();
            const tags = container.querySelectorAll(".selectable");

            tags.forEach((tag) => {
              const text = tag.textContent.toLowerCase();
              tag.style.display = text.includes(query) ? "block" : "none";
            });
          });
        });
        const subSection = document.getElementById("subroles-section");
        if (subSection) {
          subSection.addEventListener("click", (e) => {
            const target = e.target.closest(".selectable");
            if (!target) return;
            toggleSelectLabel({ currentTarget: target });
          });

          const hidden = document.querySelector('input[name="subroles"]');
          if (hidden && hidden.value) {
            subSection.closest("details").setAttribute("open", "");
          }
        }
      });
    </script>
  </head>

  <body>
    <div class="container">
      <h1>Search Clips</h1>
      <form method="GET" action="/search">
        <div class="form-row">
          <input
            name="player"
            placeholder="Player"
            list="player-list"
            value="{{ args.get('player','') }}"
          />
          <datalist id="player-list">
            {% for p in players %}
            <option value="{{ p }}"></option>
            {% endfor %}
          </datalist>
          <div class="toggle-group">
            <div
              class="toggle-button {% if args.get('side','Offense')=='Offense' %}selected{% endif %}"
              data-value="Offense"
            >
              Offense
            </div>
            <div
              class="toggle-button {% if args.get('side')=='Defense' %}selected{% endif %}"
              data-value="Defense"
            >
              Defense
            </div>
          </div>
          <input
            type="hidden"
            name="side"
            value="{{ args.get('side','Offense') }}"
          />
        </div>

        <hr class="section-divider" />

        <div class="form-row">
          <select name="playtype"></select>
          <select name="situation"></select>
        </div>
        <div class="form-row">
          <select name="outcome"></select>
          <select name="context"></select>
        </div>

        <div class="form-row">
          <div class="toggle-group quality-group">
            <div
              class="toggle-button {% if args.get('quality')=='Good' %}selected{% endif %}"
              data-value="Good"
            >
              Good
            </div>
            <div
              class="toggle-button {% if args.get('quality')=='Bad' %}selected{% endif %}"
              data-value="Bad"
            >
              Bad
            </div>
          </div>
          <input
            type="hidden"
            name="quality"
            value="{{ args.get('quality','') }}"
          />
        </div>

        <hr class="section-divider" />

        <div class="form-group">
          <label>Traits</label>
          <div class="chip-row" data-field="traits"></div>
          <input
            type="hidden"
            name="traits"
            value="{{ args.get('traits','') }}"
          />
        </div>

        <div id="roles-section" class="tag-section">
          <label>Roles</label>
          <div class="dual-column">
            <div class="column-block">
              <select class="role-select" name="offense_role"></select>
            </div>
            <div class="column-block">
              <select class="role-select" name="defense_role"></select>
            </div>
          </div>
          <input
            type="hidden"
            name="roles"
            value="{{ args.get('roles','') }}"
          />
        </div>

        <details class="subrole-drawer">
          <summary>SubRoles</summary>
          <div id="subroles-section" class="tag-section">
            <div class="dual-column compact-mode">
              <div class="column-block">
                <div class="tag-box">
                  <div class="box-header-row">
                    <span class="box-title">Offense</span>
                    <input
                      type="text"
                      class="filter-input"
                      placeholder="Search..."
                    />
                  </div>
                  <div class="tag-list scrollable" data-filter-group></div>
                </div>
              </div>
              <div class="column-block">
                <div class="tag-box">
                  <div class="box-header-row">
                    <span class="box-title">Defense</span>
                    <input
                      type="text"
                      class="filter-input"
                      placeholder="Search..."
                    />
                  </div>
                  <div class="tag-list scrollable" data-filter-group></div>
                </div>
              </div>
            </div>
            <input
              type="hidden"
              name="subroles"
              value="{{ args.get('subroles','') }}"
            />
          </div>
        </details>

        <div class="form-group">
          <details class="badge-drawer">
            <summary>Badges</summary>
            <div class="chip-row" data-field="badges"></div>
          </details>
          <input
            type="hidden"
            name="badges"
            value="{{ args.get('badges','') }}"
          />
        </div>

        <button type="submit">üîç Search</button>
      </form>

      {% if results %}
      <hr class="section-divider" />
      <button class="copy-btn" onclick="showListInFinder()">
        Show List in Finder
      </button>
      <ul class="results" id="results-list">
        {% for r in results %}
        <li data-path="{{ r.full_path }}">
          <a
            href="{{ url_for('serve_clip', player=r.player, side=r.side, filename=r.filename) }}"
            target="_blank"
          >
            {{ r.label }}
          </a>
          <button class="copy-btn" onclick="showInFinder('{{ r.full_path }}')">
            Show in Finder
          </button>
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>

    <!-- Safely inject players JSON -->
    <script id="player-data" type="application/json">
      {{ players | tojson }}
    </script>

    <script src="/static/search.js"></script>
  </body>
</html>
