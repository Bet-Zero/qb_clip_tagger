<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tag Clip</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script>
      function saveSelectValues() {
        localStorage.setItem(
          "lastPlayType",
          document.querySelector("select[name='playtype']").value
        );
        localStorage.setItem(
          "lastOutcome",
          document.querySelector("select[name='outcome']").value
        );
        localStorage.setItem(
          "lastSituation",
          document.querySelector("select[name='situation']").value
        );
        localStorage.setItem(
          "lastContext",
          document.querySelector("select[name='context']").value
        );
        localStorage.setItem(
          "lastOffenseRole",
          document.querySelector("select[name='offense_role']").value
        );
        localStorage.setItem(
          "lastDefenseRole",
          document.querySelector("select[name='defense_role']").value
        );
      }

      function closeAfterSubmit() {
        const player = document.querySelector('input[name="player"]').value;
        const side =
          document.querySelector(".toggle-button.selected")?.dataset.value ||
          "Offense";
        localStorage.setItem("lastPlayer", player);
        localStorage.setItem("lastSide", side);
        saveSelectValues();
        const subInput = document.querySelector('input[name="subroles"]');
        if (subInput) {
          localStorage.setItem("lastSubroles", subInput.value);
        }

        // Window will be closed by the server response
      }

      async function loadPlayers() {
        try {
          const res = await fetch("/players");
          if (!res.ok) return;
          const data = await res.json();
          const list = document.getElementById("player-list");
          data.players.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p;
            list.appendChild(opt);
          });
          enablePlayerSuggestions(
            document.querySelector('input[name="player"]'),
            data.players
          );
        } catch (e) {
          console.error("Failed to load players", e);
        }
      }

      function setSelectValues() {
        document.querySelector("select[name='playtype']").value =
          localStorage.getItem("lastPlayType") || "";
        document.querySelector("select[name='outcome']").value =
          localStorage.getItem("lastOutcome") || "";
        document.querySelector("select[name='situation']").value =
          localStorage.getItem("lastSituation") || "";
        document.querySelector("select[name='context']").value =
          localStorage.getItem("lastContext") || "";
        document.querySelector("select[name='offense_role']").value =
          localStorage.getItem("lastOffenseRole") || "";
        document.querySelector("select[name='defense_role']").value =
          localStorage.getItem("lastDefenseRole") || "";
        if (typeof updateRoles === "function") updateRoles();
      }

      function clearSavedSelections() {
        [
          "lastPlayType",
          "lastOutcome",
          "lastSituation",
          "lastContext",
          "lastOffenseRole",
          "lastDefenseRole",
          "lastSubroles",
        ].forEach((k) => localStorage.removeItem(k));
        setSelectValues();
      }

      window.onload = function () {
        const lastPlayer = localStorage.getItem("lastPlayer");
        const lastSide = localStorage.getItem("lastSide");

        if (lastPlayer)
          document.querySelector('input[name="player"]').value = lastPlayer;
        if (lastSide) {
          document.querySelectorAll(".toggle-button").forEach((btn) => {
            btn.classList.toggle("selected", btn.dataset.value === lastSide);
          });
          document.querySelector('input[name="side"]').value = lastSide;
        }
        loadPlayers();
        setSelectValues();

        const savedSubs = localStorage.getItem("lastSubroles");
        if (savedSubs) {
          const selections = savedSubs.split(",").filter(Boolean);
          const input = document.querySelector('input[name="subroles"]');
          document
            .querySelectorAll("#subroles-section .selectable")
            .forEach((el) => {
              if (selections.includes(el.textContent)) {
                el.classList.add("selected");
              }
            });
          if (input) input.value = savedSubs;
        }

        const subSection = document.getElementById("subroles-section");
        if (subSection) {
          subSection.addEventListener("click", (e) => {
            const target = e.target.closest(".selectable");
            if (!target) return;
            toggleSelectLabel({ currentTarget: target });
          });
        }

        document
          .querySelector('input[name="player"]')
          .addEventListener("input", (e) => {
            if (e.target.value !== localStorage.getItem("lastPlayer")) {
              clearSavedSelections();
            }
          });
      };

      function toggleSelectLabel(event) {
        const target = event.currentTarget || event.target;
        target.classList.toggle("selected");
        const field = target.dataset.field;
        const input = document.querySelector(`input[name="${field}"]`);
        const selected = [
          ...document.querySelectorAll(
            `.selectable[data-field="${field}"].selected, .chip[data-field="${field}"].selected`
          ),
        ].map((el) => el.textContent);
        input.value = selected.join(",");
        if (field === "subroles") {
          localStorage.setItem("lastSubroles", input.value);
        }
      }

      function toggleSide(event) {
        document
          .querySelectorAll(".toggle-button")
          .forEach((btn) => btn.classList.remove("selected"));
        event.target.classList.add("selected");
        document.querySelector('input[name="side"]').value =
          event.target.dataset.value;
        if (event.target.dataset.value !== localStorage.getItem("lastSide")) {
          clearSavedSelections();
        }
      }

      function filterList(input) {
        const box = input.closest(".tag-box");
        const container = box.querySelector(".tag-list");
        const query = input.value.toLowerCase();
        const tags = container.querySelectorAll(".selectable");

        tags.forEach((tag) => {
          const text = tag.textContent.toLowerCase();
          tag.style.display = text.includes(query) ? "block" : "none";
        });
      }
    </script>
  </head>

  <body>
    <div class="container">
      <h1>Tag Clip: {{ clip.filename }}</h1>
      <form method="POST" action="/submit" onsubmit="closeAfterSubmit()">
        <div class="form-row">
          <input
            name="player"
            placeholder="LeBron James"
            required
            list="player-list"
          />
          <datalist id="player-list"></datalist>
          <div class="toggle-group">
            <div
              class="toggle-button selected"
              data-value="Offense"
              onclick="toggleSide(event)"
            >
              Offense
            </div>
            <div
              class="toggle-button"
              data-value="Defense"
              onclick="toggleSide(event)"
            >
              Defense
            </div>
          </div>
          <input type="hidden" name="side" value="Offense" />
        </div>

        <hr class="section-divider" />

        <div class="form-row">
          <select name="playtype"></select>
          <select name="situation"></select>
        </div>

        <div class="form-row">
          <select name="outcome"></select>
          <select name="context"></select>
        </div>

        <hr class="section-divider" />

        <div class="form-group">
          <label>Traits</label>
          <div class="chip-row" data-field="traits"></div>
          <input type="hidden" name="traits" />
        </div>

        <!-- Roles -->
        <div id="roles-section" class="tag-section">
          <label>Roles</label>
          <div class="dual-column">
            <div class="column-block">
              <select class="role-select" name="offense_role"></select>
            </div>
            <div class="column-block">
              <select class="role-select" name="defense_role"></select>
            </div>
          </div>
          <input type="hidden" name="roles" />
        </div>

        <!-- SubRoles -->
        <details class="subrole-drawer">
          <summary>SubRoles</summary>
          <div id="subroles-section" class="tag-section">
            <div class="dual-column compact-mode">
              <div class="column-block">
                <div class="tag-box">
                  <div class="box-header-row">
                    <span class="box-title">Offense</span>
                    <input
                      type="text"
                      class="filter-input"
                      placeholder="Search..."
                      oninput="filterList(this)"
                    />
                  </div>
                  <div class="tag-list scrollable" data-filter-group></div>
                </div>
              </div>
              <div class="column-block">
                <div class="tag-box">
                  <div class="box-header-row">
                    <span class="box-title">Defense</span>
                    <input
                      type="text"
                      class="filter-input"
                      placeholder="Search..."
                      oninput="filterList(this)"
                    />
                  </div>
                  <div class="tag-list scrollable" data-filter-group></div>
                </div>
              </div>
            </div>
            <input type="hidden" name="subroles" />
          </div>
        </details>

        <div class="form-group">
          <details class="badge-drawer">
            <summary>Badges</summary>
            <div class="chip-row" data-field="badges"></div>
          </details>
          <input type="hidden" name="badges" />
        </div>

        <button type="submit">ðŸ’¾ Save Clip</button>
      </form>
    </div>

    <!-- Inject tag data -->
    <script src="{{ url_for('static', filename='taggerData.js') }}"></script>
    <script src="{{ url_for('static', filename='playerSuggest.js') }}"></script>
  </body>
</html>
